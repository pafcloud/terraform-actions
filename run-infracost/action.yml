name: run-infracost
description: Runs infracost to get a cost estimate.

inputs:
  plan-file:
    description: Path to saved terraform plan file
    required: true

  working-directory:
    description: Working directory, in which the infracost command is run
    required: true

outputs:
  output:
    description: infracost output (diff)
    value: ${{ steps.this.outputs.output }}
  summary:
    description: Short summary containing old monthly + new monthly
    value: ${{ steps.this.outputs.summary }}

runs:
  using: composite
  steps:
  
    - id: resolve-usage-file
      name: Resolve infracost default usage file
      working-directory: ${{ inputs.working-directory }}
      shell: bash
      run: |
        if [ -z "$GITHUB_WORKSPACE" ]; then
            echo "ERROR: environment variable GITHUB_WORKSPACE is unset"
            exit 1
        fi
        search_stop_dir="$(dirname $GITHUB_WORKSPACE)"
        upcat() {
            declare –a file_path_array=()
            file="$1"
            while [ "$PWD" != "$search_stop_dir" -a "$PWD" != "/" ]; do
                if [ -r "$file" ]; then
                    file_path_array+=("$PWD"/resource-use.yaml)
                fi
                cd ..
            done
            echo "${file_path_array[*]}"
        }
        
        resource_use="$(upcat resource-use.yaml)"
        if [ -z "$resource_use" ]; then
            echo "ERROR: Cannot resolve resource-use.yaml: no resource-use.yaml file found"
            exit 2
        fi        
        echo "resource-use=${resource_use[@]}" >> $GITHUB_OUTPUT
       
    - id: merge-dictionary-files
      working-directory: ${{ inputs.working-directory }}
      shell: python 
      env:
        RESOURCE: ${{ steps.resolve-usage-file.outputs.resource-use }}
      run: |
        import yaml
        import os

        array_str = os.getenv('RESOURCE')
        array = array_str.split(' ')
        try:
            with open(array[1], 'r') as file: #Root
                root = yaml.safe_load(file)
            with open(array[0], 'r') as file2: #Dev
                dev = yaml.safe_load(file2)
        except:
            print("could not load the resource files")

        def merge_dicts(root_dict, dev_dict):
          for key, value in dev_dict.items():
            if key in root_dict:
              if isinstance(root_dict[key], dict) and isinstance(value, dict):
                root_dict[key] = merge_dicts(root_dict[key], value)
              else:
                root_dict[key] = value
          return root_dict

        try:
            runner_temp = os.getenv('RUNNER_TEMP')
            print("RUNNER TEMP:" ,runner_temp)
            merged_dict = merge_dicts(root, dev)
            with open(runner_temp +"/result.yml", 'w') as yaml_file:  #Dumps the file into dev file
                yaml.dump(merged_dict, yaml_file, default_flow_style=False) 
        except:
            print("Could not merget the dev and root files")
 
    - id: this
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        INFRACOST_CURRENCY: EUR
        INFRACOST_CURRENCY_FORMAT: "EUR: 1.234,56€"
        PLAN_FILE: ${{ inputs.plan-file }}
        RESOURCE_USE: ${{ steps.resolve-usage-file.outputs.resource-use }}
      run: |
      
        #echo "RESOURCE USE" $RESOURCE_USE
        tmp_dir=$(mktemp -d $RUNNER_TEMP/infracost.XXXXXXXXXX)
        terragrunt show -json $PLAN_FILE > $tmp_dir/plan.json
        infracost diff --path $tmp_dir/plan.json --format=json --usage-file $RUNNER_TEMP/result.yml >> $tmp_dir/infracost.json

        # generate normal output from json
        echo "output<<EOF" >> $GITHUB_OUTPUT
        infracost output --format table --path $tmp_dir/infracost.json >> $GITHUB_OUTPUT
        echo EOF >> $GITHUB_OUTPUT

        # generate summary from json
        currentMonthly=$(jq -r '.projects | .[] | " \(.breakdown.totalMonthlyCost) "' < $tmp_dir/infracost.json)
        pastMonthly=$(jq -r '.projects | .[] | " \(.pastBreakdown.totalMonthlyCost)"' < $tmp_dir/infracost.json)
        echo "summary=$(echo $pastMonthly | awk '{printf("%.2f \n",$1)}')→ $(echo $currentMonthly | awk '{printf("%.2f \n",$1)}')" >> $GITHUB_OUTPUT
