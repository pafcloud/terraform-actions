name: infracost
description: Runs infracost to get a cost estimate.
  
inputs:
  working-directory:
    description: Working directory, in which the infracost command is run
    required: true
    default: ${{ runner.temp }}

outputs:
  output:
    description: infracost output (diff)
    value: ${{ steps.this.outputs.output }}
  summary: 
    description: Short summary containing old monthly + new monthly
    value: ${{ steps.this.outputs.summary }}

runs:
  using: composite
  steps: 
    - id: this
      shell: bash
      with:
        WORKING_DIRECTORY: ${{ inputs.working-directory }}
      run: |
     
        terragrunt show -json  $WORKING_DIRECTORY/plan.tfplan > $WORKING_DIRECTORY/plan.json
        infracost configure set currency EUR
        infracost diff --path=$WORKING_DIRECTORY/plan.json --format=json >> $WORKING_DIRECTORY/infracost.json

        # generate normal output from json
        echo "output<<EOF" >> $GITHUB_OUTPUT
        infracost diff --path=$WORKING_DIRECTORY/plan.json --format=diff >> $GITHUB_OUTPUT 
        echo EOF >> $GITHUB_OUTPUT  

        # generate summary from json
        echo "summary=$(jq -r '.projects | .[] | " \(.pastBreakdown.totalMonthlyCost) → \(.breakdown.totalMonthlyCost)"' < $WORKING_DIRECTORY/infracost.json) €/Month" >> $GITHUB_OUTPUT
        echo EOF >> $GITHUB_OUTPUT
